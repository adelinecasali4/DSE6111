---
title: "Final Project DSE6111"
author: "Adeline Casali"
date: "2023-12-05"
output: word_document
---

# Section 1: What subset of predictors can be used for preventative health screening for heart disease? 

**Loading data and packages**
```{r}
heart_df <- read.csv("Data/heart_disease_health_indicators_BRFSS2015.csv")
library(corrplot)
library(tidyverse)
library(MASS)
library(e1071)
library(class)
library(tree)
library(randomForest)
library(gbm)
library(kableExtra)
```
**Data exploration and tidying**   
The only predictors that have a correlation stronger than 0.5 are physical health and general health with a correlation of 0.52. 
```{r}
# View the dataset and summary statistics
head(heart_df)
summary(heart_df)
str(heart_df)
dim(heart_df)
names(heart_df)

# Check for correlated variables
cor_matrix <- cor(heart_df)
corrplot(cor_matrix, method = "color", tl.col = "black", tl.srt = 45)
title("Correlation Heatmap")
cor_matrix <- cor(heart_df)
cor_matrix_filtered <- cor_matrix
cor_matrix_filtered[abs(cor_matrix) <= 0.5] <- NA
print(cor_matrix_filtered)

# Convert HeartDiseaseorAttack to factor
heart_df$HeartDiseaseorAttack <- as.factor(heart_df$HeartDiseaseorAttack)
```
**Logistic Regression**    
The linear model with all predictors shows that the variables HighBP, HighChol, CholCheck, Smoker, Stroke, Diabetes, HvyAlcoholConsump, NoDocbcCost, GenHlth, DiffWalk, Sex, Age, and Income were the most significant predictors, followed by PhysActivity, Veggies, and MentHlth. The model created with all of the significant predictors has an accuracy of 89.78%, and the model created with only the most significant predictors has the same accuracy of 89.78%. 
```{r}
# Null model
heart_lm_null <- glm(HeartDiseaseorAttack ~ HeartDiseaseorAttack, data = heart_df, family = binomial)
summary(heart_lm_null)

# Model with all predictors
heart_lm <- glm(HeartDiseaseorAttack ~ ., data = heart_df, family = binomial)
summary(heart_lm)

# Create a training and testing set
set.seed(123)
heart_train <- heart_df %>% 
  sample_frac(0.7)
heart_test <- anti_join(heart_df, heart_train)

# Model with significant predictors
heart_lm_sig <- glm(HeartDiseaseorAttack ~ HighBP + HighChol + CholCheck + Smoker + Stroke + Diabetes + HvyAlcoholConsump + NoDocbcCost + GenHlth + DiffWalk + Sex + Age + Income + PhysActivity + Veggies + MentHlth, data = heart_train, family = binomial)
summary(heart_lm_sig)

# Test the model and calculate accuracy
predict_lm <- predict(heart_lm_sig, newdata = heart_test)
binary_predict_lm <- ifelse(predict_lm > 0.5, 1, 0)
results <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack, 
  Predicted = binary_predict_lm
)
results$Correct <- results$Actual == results$Predicted
confusion_matrix_lm <- table(Predicted = results$Predicted, Actual = results$Actual)
print(confusion_matrix_lm)
accuracy_lm <- (59853 + 391) / (59853 + 6623 + 234 + 391)
error_lm <- 1 - accuracy_lm
cat("Accuracy:", accuracy_lm, "\n")
cat("Error Rate:", error_lm, "\n")

# Model with only the most significant predictors
heart_lm_sig2 <- glm(HeartDiseaseorAttack ~ HighBP + HighChol + CholCheck + Smoker + Stroke + Diabetes + HvyAlcoholConsump + NoDocbcCost + GenHlth + DiffWalk + Sex + Age + Income, data = heart_train, family = binomial)
summary(heart_lm_sig2)

# Test the second model and calculate accuracy
predict_lm2 <- predict(heart_lm_sig2, newdata = heart_test)
binary_predict_lm2 <- ifelse(predict_lm2 > 0.5, 1, 0)
results2 <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack, 
  Predicted = binary_predict_lm2
)
results2$Correct <- results2$Actual == results2$Predicted
confusion_matrix_lm2 <- table(Predicted = results2$Predicted, Actual = results2$Actual)
print(confusion_matrix_lm2)
accuracy_lm2 <- (59847 + 396) / (59847 + 6618 + 240 + 396)
error_lm2 <- 1 - accuracy_lm2
cat("Accuracy:", accuracy_lm2, "\n")
cat("Error Rate:", error_lm2, "\n")
```
**LDA**    
The LDA model containing all significant predictors has an accuracy of 89.14%. 
```{r}
# Model with significant predictors
heart_lda <- lda(HeartDiseaseorAttack ~ HighBP + HighChol + CholCheck + Smoker + Stroke + Diabetes + HvyAlcoholConsump + NoDocbcCost + GenHlth + DiffWalk + Sex + Age + Income + PhysActivity + Veggies + MentHlth, data = heart_train)
heart_lda

# Test the model and calculate accuracy
lda_predictions <- predict(heart_lda, newdata = heart_test)$class
lda_results <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack,
  Predicted = lda_predictions
)
lda_results$Correct <- lda_results$Actual == lda_results$Predicted
lda_confusion_matrix <- table(Predicted = lda_results$Predicted, Actual = lda_results$Actual)
print(lda_confusion_matrix)
accuracy_lda <- (58497 + 1320) / (58497 + 5694 + 1590 + 1320)
error_lda <- 1 - accuracy_lda
cat("Accuracy:", accuracy_lda, "\n")
cat("Error Rate:", error_lda, "\n")
```
**QDA**   
The QDA model containing all significant predictors has an accuracy of 83.25%.
```{r}
# Model with significant predictors
heart_qda <- qda(HeartDiseaseorAttack ~ HighBP + HighChol + CholCheck + Smoker + Stroke + Diabetes + HvyAlcoholConsump + NoDocbcCost + GenHlth + DiffWalk + Sex + Age + Income + PhysActivity + Veggies + MentHlth, data = heart_train)
heart_qda

# Test the model and calculate accuracy
qda_predictions <- predict(heart_qda, newdata = heart_test)$class
qda_results <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack,
  Predicted = qda_predictions
)
qda_results$Correct <- qda_results$Actual == qda_results$Predicted
qda_confusion_matrix <- table(Predicted = qda_results$Predicted, Actual = qda_results$Actual)
print(qda_confusion_matrix)
accuracy_qda <- (52651 + 3212) / (52651 + 3802 + 7436 + 3212)
error_qda <- 1 - accuracy_qda
cat("Accuracy:", accuracy_qda, "\n")
cat("Error Rate:", error_qda, "\n")
```
**Naive Bayes**    
The Naive Bayes model containing all significant predictors has an accuracy of 80.39%.
```{r}
# Model with significant predictors
heart_nb <- naiveBayes(HeartDiseaseorAttack ~ HighBP + HighChol + CholCheck + Smoker + Stroke + Diabetes + HvyAlcoholConsump + NoDocbcCost + GenHlth + DiffWalk + Sex + Age + Income + PhysActivity + Veggies + MentHlth, data = heart_train)
heart_nb

# Test the model and calculate accuracy
nb_predictions <- predict(heart_nb, newdata = heart_test)
nb_results <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack,
  Predicted = nb_predictions
)
nb_results$Correct <- nb_results$Actual == nb_results$Predicted
nb_confusion_matrix <- table(Predicted = nb_results$Predicted, Actual = nb_results$Actual)
print(nb_confusion_matrix)
accuracy_nb <- (50161 + 3780) / (50161 + 3234 + 9926 + 3780)
error_nb <- 1 - accuracy_nb
cat("Accuracy:", accuracy_nb, "\n")
cat("Error Rate:", error_nb, "\n")
```
**KNN (K-Nearest Neighbors)**   
The KNN model containing all significant predictors and K=3 has an accuracy of 98.13%. 
```{r}
# Model with all significant predictors and K = 3
predictors <- c(
  "HighBP", "HighChol", "CholCheck", "Smoker", "Stroke", "Diabetes",
  "HvyAlcoholConsump", "NoDocbcCost", "GenHlth", "DiffWalk",
  "Sex", "Age", "Income", "PhysActivity", "Veggies", "MentHlth"
)
train_data <- heart_train[, c(predictors, "HeartDiseaseorAttack")]
test_data <- heart_test[, c(predictors, "HeartDiseaseorAttack")]
knn_predictions <- knn(
  train = train_data[, -length(predictors)],
  test = test_data[, -length(predictors)],
  cl = train_data$HeartDiseaseorAttack,
  k = 3
)
knn_results <- data.frame(
  Actual = test_data$HeartDiseaseorAttack,
  Predicted = knn_predictions
)
knn_results$Correct <- knn_results$Actual == knn_results$Predicted
knn_confusion_matrix <- table(Predicted = knn_results$Predicted, Actual = knn_results$Actual)
print(knn_confusion_matrix)
accuracy_knn <- (60082 + 5763) / (60082 + 1251 + 5 + 5763)
error_knn <- 1 - accuracy_knn
cat("Accuracy:", accuracy_knn, "\n")
cat("Error Rate:", error_knn, "\n")

# Model with all significant predictors and K = 5
knn_predictions2 <- knn(
  train = train_data[, -length(predictors)],
  test = test_data[, -length(predictors)],
  cl = train_data$HeartDiseaseorAttack,
  k = 5
)
knn_results2 <- data.frame(
  Actual = test_data$HeartDiseaseorAttack,
  Predicted = knn_predictions2
)
knn_results2$Correct <- knn_results2$Actual == knn_results2$Predicted
knn_confusion_matrix2 <- table(Predicted = knn_results2$Predicted, Actual = knn_results2$Actual)
print(knn_confusion_matrix2)
accuracy_knn2 <- (60085 + 5606) / (60085 + 1408 + 2 + 5606)
error_knn2 <- 1 - accuracy_knn2
cat("Accuracy:", accuracy_knn2, "\n")
cat("Error Rate:", error_knn2, "\n")

# Model with all significant predictors and K = 10
knn_predictions3 <- knn(
  train = train_data[, -length(predictors)],
  test = test_data[, -length(predictors)],
  cl = train_data$HeartDiseaseorAttack,
  k = 10
)
knn_results3 <- data.frame(
  Actual = test_data$HeartDiseaseorAttack,
  Predicted = knn_predictions3
)
knn_results3$Correct <- knn_results3$Actual == knn_results3$Predicted
knn_confusion_matrix3 <- table(Predicted = knn_results3$Predicted, Actual = knn_results3$Actual)
print(knn_confusion_matrix3)
accuracy_knn3 <- (60087 + 5340) / (60087 + 1674 + 0 + 5340)
error_knn3 <- 1 - accuracy_knn3
cat("Accuracy:", accuracy_knn3, "\n")
cat("Error Rate:", error_knn3, "\n")
```
**Classification Trees**   
The classification tree containing all predictors and pruned with cross-validation has an accuracy of 89.55%. 
```{r}
# Model with all predictors
heart_tree <- tree(HeartDiseaseorAttack ~ ., heart_train)
summary(heart_tree)
plot(heart_tree)
text(heart_tree, pretty = 0)

# Test the model and calculate accuracy
tree_predict <- predict(heart_tree, heart_test, type = "class")
tree_results <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack,
  Predicted = tree_predict
)
tree_results$Correct <- tree_results$Actual == tree_results$Predicted
tree_confusion_matrix <- table(Predicted = tree_results$Predicted, Actual = tree_results$Actual)
print(tree_confusion_matrix)
accuracy_tree <- (60087 + 0) / (60087 + 7014 + 0 + 0)
error_tree <- 1 - accuracy_tree
cat("Accuracy:", accuracy_tree, "\n")
cat("Error Rate:", error_tree, "\n")

# Prune the tree with cross-validation
set.seed(123)
cv_heart <- cv.tree(heart_tree, FUN = prune.misclass)
cv_heart
prune_heart <- prune.misclass(heart_tree, best = 5)
plot(prune_heart)
text(prune_heart, pretty = 0)

# Test the pruned tree and calculate accuracy
tree_predict2 <- predict(prune_heart, heart_test, type = "class")
tree_results2 <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack,
  Predicted = tree_predict2
)
tree_results2$Correct <- tree_results2$Actual == tree_results2$Predicted
tree_confusion_matrix2 <- table(Predicted = tree_results2$Predicted, Actual = tree_results2$Actual)
print(tree_confusion_matrix2)
accuracy_tree2 <- (60087 + 0) / (60087 + 7014 + 0 + 0)
error_tree2 <- 1 - accuracy_tree2
cat("Accuracy:", accuracy_tree2, "\n")
cat("Error Rate:", error_tree2, "\n")

# The pruned and unpruned trees are the same
```
**Bagging**   
The bagged classification tree containing all predictors has an accuracy of 87.75%. The most important predictors in the tree are (1) Age, (2) BMI, and (3) Income. 
```{r}
# Model with all predictors
set.seed(123)
heart_bag <- randomForest(HeartDiseaseorAttack ~ ., data = heart_train, mtry = 16, importance = TRUE, ntree = 25)
heart_bag
importance(heart_bag)

# Test the model and calculate accuracy
tree_predict_bag <- predict(heart_bag, heart_test, type = "class")
tree_results_bag <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack,
  Predicted = tree_predict_bag
)
tree_results_bag$Correct <- tree_results_bag$Actual == tree_results_bag$Predicted
tree_confusion_matrix_bag <- table(Predicted = tree_results_bag$Predicted, Actual = tree_results_bag$Actual)
print(tree_confusion_matrix_bag)
accuracy_tree_bag <- (57539 + 1341) / (57539 + 5673 + 2548 + 1341)
error_tree_bag <- 1 - accuracy_tree_bag
cat("Accuracy:", accuracy_tree_bag, "\n")
cat("Error Rate:", error_tree_bag, "\n")
```
**Random Forests**   
The random forest classification tree containing all predictors has an accuracy of 89.45%. The most important predictors in the tree are (1) Age, (2) BMI, and (3) GenHlth. 
```{r}
# Model with all predictors
set.seed(123)
heart_rf <- randomForest(HeartDiseaseorAttack ~ ., data = heart_train, mtry = 4, importance = TRUE, ntree = 25)
heart_rf
importance(heart_rf)

# Test the model and calculate accuracy
tree_predict_rf <- predict(heart_rf, heart_test, type = "class")
tree_results_rf <- data.frame(
  Actual = heart_test$HeartDiseaseorAttack,
  Predicted = tree_predict_rf
)
tree_results_rf$Correct <- tree_results_rf$Actual == tree_results_rf$Predicted
tree_confusion_matrix_rf <- table(Predicted = tree_results_rf$Predicted, Actual = tree_results_rf$Actual)
print(tree_confusion_matrix_rf)
accuracy_tree_rf <- (59362 + 679) / (59362 + 6335 + 725 + 679)
error_tree_rf <- 1 - accuracy_tree_rf
cat("Accuracy:", accuracy_tree_rf, "\n")
cat("Error Rate:", error_tree_rf, "\n")
```
**Overview of models**   
Overall, the model with the highest accuracy is kNN with k=3. This model has an accuracy of 98.13%. 
```{r}
# Table with models and relative accuracies
classification_overview <- data.frame(
  Method = c("Logistic Regression", "LDA", "QDA", "Naive Bayes", "kNN (k=3)", "CV Tree", "Bagging", "Random Forest"),
  Accuracy = c("89.78%", "89.14%", "83.25%", "80.39%", "98.13%", "89.55%", "87.75%", "89.45%")
)
classification_table <- kable(classification_overview, "markdown") %>%
  kable_styling(full_width = FALSE) %>%
  column_spec(1, bold = TRUE)
classification_table
```


# Section 2: What indicators can be used to monitor for HIV response in children and adolescents? 
